# GitHub Pages Deployment Workflow
#
# Composes and deploys the full site from multiple content directories.
# Triggered by workflow_dispatch (typically from project-administration after pushing content).
#
# Site structure:
#   /              ← from site-root/index.html
#   /releases/     ← from releases/
#   /swagger-ui/   ← from swagger-ui/

name: Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository that triggered deployment (for logging)'
        required: false
        type: string
      source_sha:
        description: 'Source commit SHA (for logging)'
        required: false
        type: string
      changed_segment:
        description: 'Which segment was updated: releases|swagger-ui|site-root (for logging)'
        required: false
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compose Pages site artifact
        run: |
          rm -rf _site
          mkdir -p _site

          # Root landing page
          cp site-root/index.html _site/index.html

          # Sub-sites
          mkdir -p _site/releases _site/swagger-ui
          cp -R releases/. _site/releases/
          cp -R swagger-ui/. _site/swagger-ui/

          # Avoid Jekyll processing
          touch _site/.nojekyll

          echo "Site artifact composed:"
          find _site -type f | head -20

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "## GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ github.event.inputs.source_repo }}" ]]; then
            echo "### Source" >> $GITHUB_STEP_SUMMARY
            echo "- **Repository**: ${{ github.event.inputs.source_repo }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit**: ${{ github.event.inputs.source_sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Changed**: ${{ github.event.inputs.changed_segment }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "### Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
